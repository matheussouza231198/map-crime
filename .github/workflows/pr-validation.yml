name: PR Template Validation

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Check PR Description
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = context.payload.pull_request.body || '';
            
            // Se√ß√µes obrigat√≥rias do template
            const requiredSections = [
              '## üìù Descri√ß√£o',
              '## üéØ Tipo de Mudan√ßa',
              '## üß™ Como Testar',
              '## ‚úÖ Checklist'
            ];
            
            // Itens obrigat√≥rios do checklist
            const requiredChecklistItems = [
              'C√≥digo segue os padr√µes do projeto',
              'Realizei self-review do c√≥digo',
              'Testes unit√°rios novos e existentes passam localmente',
              'O linter passou sem erros'
            ];
            
            const errors = [];
            
            // Valida se todas as se√ß√µes existem
            for (const section of requiredSections) {
              if (!prBody.includes(section)) {
                errors.push(`‚ùå Se√ß√£o obrigat√≥ria faltando: "${section}"`);
              }
            }
            
            // Valida se descri√ß√£o n√£o est√° vazia
            const descriptionMatch = prBody.match(/## üìù Descri√ß√£o\s*\n\s*<!--[\s\S]*?-->\s*\n\s*([\s\S]*?)(?=\n##|$)/);
            if (descriptionMatch) {
              const description = descriptionMatch[1].trim();
              if (!description || description.length < 10) {
                errors.push('‚ùå A descri√ß√£o est√° muito curta ou vazia (m√≠nimo 10 caracteres)');
              }
            } else {
              errors.push('‚ùå Se√ß√£o de descri√ß√£o n√£o encontrada ou malformada');
            }
            
            // Valida se pelo menos um tipo de mudan√ßa foi selecionado
            const typeSection = prBody.match(/## üéØ Tipo de Mudan√ßa\s*([\s\S]*?)(?=\n##|$)/);
            if (typeSection) {
              const hasCheckedType = /- \[x\]/i.test(typeSection[1]);
              if (!hasCheckedType) {
                errors.push('‚ùå Nenhum tipo de mudan√ßa foi selecionado');
              }
            }
            
            // Valida se tem passos de teste
            const testSection = prBody.match(/## üß™ Como Testar\s*\n\s*<!--[\s\S]*?-->\s*\n\s*([\s\S]*?)(?=\n##|$)/);
            if (testSection) {
              const testSteps = testSection[1].trim();
              if (!testSteps || testSteps.length < 10) {
                errors.push('‚ùå Se√ß√£o "Como Testar" est√° vazia ou muito curta');
              }
            }
            
            // Valida checklist obrigat√≥rio
            const checklistSection = prBody.match(/## ‚úÖ Checklist\s*([\s\S]*?)(?=\n##|$)/);
            if (checklistSection) {
              for (const item of requiredChecklistItems) {
                const isChecked = new RegExp(`- \\[x\\].*${item}`, 'i').test(checklistSection[1]);
                if (!isChecked) {
                  errors.push(`‚ùå Item obrigat√≥rio do checklist n√£o marcado: "${item}"`);
                }
              }
            }
            
            // Se houver erros, falha o check
            if (errors.length > 0) {
              const errorMessage = [
                '# ‚õî PR Template Validation Failed',
                '',
                'Este Pull Request n√£o segue o template obrigat√≥rio. Por favor, corrija os seguintes problemas:',
                '',
                ...errors,
                '',
                '## üìã Template Completo',
                '',
                'Seu PR deve incluir todas as se√ß√µes obrigat√≥rias:',
                '- üìù Descri√ß√£o clara e detalhada (m√≠nimo 10 caracteres)',
                '- üéØ Tipo de mudan√ßa selecionado',
                '- üß™ Passos para testar',
                '- ‚úÖ Todos os itens obrigat√≥rios do checklist marcados',
                '',
                '## üîß Como corrigir',
                '',
                '1. Edite a descri√ß√£o do PR',
                '2. Preencha todas as se√ß√µes obrigat√≥rias',
                '3. Marque os itens do checklist',
                '4. Salve as altera√ß√µes',
                '',
                '‚ö†Ô∏è **Este PR ser√° bloqueado at√© que todos os requisitos sejam atendidos.**'
              ].join('\n');
              
              // Posta coment√°rio com os erros
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: errorMessage
              });
              
              // Adiciona label de bloqueio
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: ['‚õî blocked', 'template-incomplete']
              });
              
              core.setFailed(`PR template validation failed with ${errors.length} error(s)`);
            } else {
              // Remove label de bloqueio se existir
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  name: '‚õî blocked'
                });
              } catch (error) {
                // Label pode n√£o existir, ignora erro
              }
              
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  name: 'template-incomplete'
                });
              } catch (error) {
                // Label pode n√£o existir, ignora erro
              }
              
              // Posta coment√°rio de sucesso
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: '‚úÖ **PR Template Validation Passed!**\n\nTodos os requisitos do template foram atendidos. Obrigado por seguir os padr√µes do projeto! üéâ'
              });
              
              core.info('‚úÖ PR template validation passed');
            }
